# This script enables wss diagnostics for multiple Azure Stack HCI clusters.

# Code starts here

# Set the subscription ID, resource group, and tenant ID 
$subscriptionId = ""
$resourceGroup = ""
$tenantId = ""

# Use a specified tenant ID to log in.
$login = az login --tenant $tenantId
# Change the active subscription to the specified subscription ID.
az account set -s  $subscriptionId

# Retrieve a list of all cluster IDs in the specified resource group.
$clusters = az resource list --resource-group $resourceGroup --resource-type "Microsoft.AzureStackHCI/clusters" --query "[].id" -o tsv

# For each of the cluster, update the clusters with new properties.
foreach ($currentCluster in $clusters) {
	# Use Azure CLI to enable wss for the current cluster
	Start-Job -ScriptBlock {
		az stack-hci cluster update --desired-properties diagnostic-level="Enhanced" windows-server-subscription="Enabled" --tags DoNotDelete="true" demo="true" --ids $using:currentCluster
	}
}