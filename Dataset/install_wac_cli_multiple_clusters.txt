# This script installs Windows Admin Center Arc Extension for multiple Azure Stack HCI Clusters.

#Code starts here

# Initialize subscriptionId, resourceGroup and tenantId.
$subscriptionId = ""
$resourceGroup = ""
$tenantId = ""

# Logging in to Azure using the tenant ID
az login --tenant $tenantId
# Setting the subscription ID
az account set -s  $subscriptionId

$settingsPath = "path to port-wac.json"
$connectivityPath = "path to connectivity.json"

# Gathering the names of Azure Stack HCI clusters in the specified resource group
$clusters = @(az resource list --resource-group $resourceGroup --resource-type "Microsoft.AzureStackHCI/clusters" --query "[].name" -o tsv)

# Looping over the cluster names and enabling connectivity and installing the WAC extension for each
foreach ($currentCluster in $clusters) {
    Start-Job -ScriptBlock {
        "Enabling Connectivity for cluster $using:currentCluster"
        # Updating connectivity properties with the specified settings
        az stack-hci arc-setting update --resource-group $using:resourceGroup --cluster-name $using:currentCluster --name "default" --connectivity-properties @$using:connectivityPath
        "Installing WAC extension for cluster $using:currentCluster"
        # Installing the WAC extension with the specified parameters
        az stack-hci extension create --arc-setting-name "default" --cluster-name $using:currentCluster --extension-name "AdminCenter" --resource-group $using:resourceGroup --publisher "Microsoft.AdminCenter" --type "AdminCenter" --settings @$using:settingsPath
    }
}
