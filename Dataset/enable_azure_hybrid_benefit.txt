//This is the script for enabling azure hybrid benefit for multiple Azure Stack HCI clusters.

# Define tenant, subscription and resourceGroup.
$tenant = ""
$subscription = ""
$resourceGroup = ""

# Set the active Azure subscription to the one specified in `$subscription`
Set-AzContext -Subscription $subscription

# Query Azure to get a list of clusters in the specified resource group
$clusters = (Get-AzResource -ResourceGroupName $resourceGroup -ResourceType "Microsoft.AzureStackHCI/clusters").Name

# For each cluster, enable the software assurance benefit by sending an API call to Azure
foreach ($cluster in $Clusters) {
    Invoke-AzRestMethod -Method POST `
    -SubscriptionId $subscription `
    -ResourceGroupName $resourceGroup `
    -ResourceProviderName "Microsoft.AzureStackHCI" `
    -ResourceType "clusters" `
    -Name ($cluster + "/extendSoftwareAssuranceBenefit") `
    -ApiVersion "2023-02-01" `
    -Payload '{"properties": { "softwareAssuranceIntent": "Enable" }}'
}